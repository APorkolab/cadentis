<div class="analytics-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">
        <span class="icon">📊</span>
        Advanced Analytics Dashboard
      </h1>
      <div class="header-controls">
        <!-- Time Range Selector -->
        <select 
          [(ngModel)]="selectedTimeRange" 
          (change)="onTimeRangeChange(selectedTimeRange)"
          class="time-range-select">
          <option value="1h">Last Hour</option>
          <option value="24h">Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
        </select>
        
        <!-- Real-time Toggle -->
        <button 
          class="realtime-toggle"
          [class.active]="isRealTimeEnabled"
          (click)="onRealTimeToggle()"
          title="Toggle real-time updates">
          <span class="status-dot" [class.live]="isRealTimeEnabled"></span>
          {{ isRealTimeEnabled ? 'LIVE' : 'PAUSED' }}
        </button>
        
        <!-- Export Button -->
        <div class="export-section">
          <select [(ngModel)]="selectedExportFormat" class="export-format">
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
            <option value="pdf">PDF</option>
          </select>
          <button class="export-btn" (click)="onExportData()">
            📥 Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Loading analytics data...</p>
  </div>

  <!-- Main Dashboard Content -->
  <div class="dashboard-content" *ngIf="!isLoading && metrics">
    <!-- Key Metrics Overview -->
    <div class="metrics-overview">
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-icon">👥</span>
          <span class="metric-label">Total Users</span>
        </div>
        <div class="metric-value">{{ formatNumber(metrics.totalUsers) }}</div>
        <div class="metric-change positive">+12.5% vs last period</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-icon">📈</span>
          <span class="metric-label">Active Users</span>
        </div>
        <div class="metric-value">{{ formatNumber(metrics.activeUsers) }}</div>
        <div class="metric-change positive">+8.3% vs last period</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-icon">🔍</span>
          <span class="metric-label">Page Views</span>
        </div>
        <div class="metric-value">{{ formatNumber(metrics.pageViews) }}</div>
        <div class="metric-change negative">-2.1% vs last period</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-header">
          <span class="metric-icon">🎯</span>
          <span class="metric-label">Conversion Rate</span>
        </div>
        <div class="metric-value">{{ formatPercentage(metrics.conversionRate) }}</div>
        <div class="metric-change positive">+5.7% vs last period</div>
      </div>
    </div>

    <!-- Real-time Stats -->
    <div class="realtime-section" *ngIf="isRealTimeEnabled">
      <div class="section-header">
        <h2>🔴 Real-time Activity</h2>
        <div class="live-indicator">
          <span class="pulse-dot"></span>
          {{ realTimeStats.activeUsers }} users online now
        </div>
      </div>
      
      <div class="realtime-grid">
        <div class="realtime-card">
          <h3>Recent Events</h3>
          <div class="events-list">
            <div 
              *ngFor="let event of realTimeStats.recentEvents" 
              class="event-item">
              <span class="event-icon">{{ getEventTypeIcon(event.type) }}</span>
              <span class="event-details">
                {{ event.category }}/{{ event.action }}
                <small>{{ event.timestamp | date:'short' }}</small>
              </span>
            </div>
          </div>
        </div>
        
        <div class="realtime-card">
          <h3>Top Active Pages</h3>
          <div class="pages-list">
            <div 
              *ngFor="let page of realTimeStats.topPages" 
              class="page-item">
              <span class="page-path">{{ page.path }}</span>
              <span class="page-views">{{ page.views }} views</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <!-- Metrics Overview Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>📊 Metrics Overview</h3>
        </div>
        <div class="chart-placeholder" *ngIf="metricsChartData">
          <div class="doughnut-chart-mock">
            <div 
              *ngFor="let item of metricsChartData.labels; let i = index"
              class="chart-segment"
              [style.background-color]="metricsChartData.datasets[0].backgroundColor[i]">
              <span class="segment-label">{{ item }}</span>
              <span class="segment-value">{{ formatNumber(metricsChartData.datasets[0].data[i]) }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Traffic Sources Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>🌐 Traffic Sources</h3>
        </div>
        <div class="chart-placeholder" *ngIf="trafficChartData">
          <div class="pie-chart-mock">
            <div 
              *ngFor="let label of trafficChartData.labels; let i = index"
              class="traffic-item">
              <span 
                class="traffic-color" 
                [style.background-color]="trafficChartData.datasets[0].backgroundColor[i]"></span>
              <span class="traffic-label">{{ label }}</span>
              <span class="traffic-percentage">{{ trafficChartData.datasets[0].data[i] }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversion Funnels -->
    <div class="funnels-section" *ngIf="conversionFunnels.length > 0">
      <div class="section-header">
        <h2>🎯 Conversion Funnels</h2>
      </div>
      
      <div 
        *ngFor="let funnel of conversionFunnels" 
        class="funnel-container">
        <div class="funnel-header">
          <h3>{{ funnel.name }}</h3>
          <div class="funnel-stats">
            <span>{{ formatNumber(funnel.totalUsers) }} users</span>
            <span>{{ formatPercentage(funnel.conversionRate) }} conversion</span>
          </div>
        </div>
        
        <div class="funnel-steps">
          <div 
            *ngFor="let step of funnel.steps; let i = index"
            class="funnel-step"
            [style.width.%]="step.completionRate * 100"
            (click)="onFunnelStepClick(funnel, step)">
            <div class="step-header">
              <span class="step-name">{{ step.name }}</span>
              <span class="step-rate">{{ formatPercentage(step.completionRate) }}</span>
            </div>
            <div class="step-users">{{ formatNumber(step.completedUsers) }} users</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Segments -->
    <div class="segments-section" *ngIf="userSegments.length > 0">
      <div class="section-header">
        <h2>👥 User Segments</h2>
      </div>
      
      <div class="segments-grid">
        <div 
          *ngFor="let segment of userSegments; let i = index"
          class="segment-card"
          (click)="onSegmentClick(segment)">
          <div class="segment-header">
            <h3>{{ segment.name }}</h3>
            <span 
              class="segment-color" 
              [style.background-color]="getSegmentColor(i)"></span>
          </div>
          
          <div class="segment-stats">
            <div class="stat">
              <span class="stat-label">Users</span>
              <span class="stat-value">{{ formatNumber(segment.userCount) }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Conversion</span>
              <span class="stat-value">{{ formatPercentage(segment.conversionRate) }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Avg Session</span>
              <span class="stat-value">{{ formatDuration(segment.avgSessionDuration) }}</span>
            </div>
          </div>
          
          <div class="segment-features">
            <h4>Top Features</h4>
            <div 
              *ngFor="let feature of segment.topFeatures" 
              class="feature-item">
              <span class="feature-name">{{ feature.name }}</span>
              <span class="feature-usage">{{ feature.usage }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- A/B Testing Experiments -->
    <div class="experiments-section">
      <div class="section-header">
        <h2>🧪 A/B Testing Experiments</h2>
      </div>
      
      <div class="experiments-grid">
        <div 
          *ngFor="let experiment of activeExperiments"
          class="experiment-card">
          <div class="experiment-header">
            <h3>{{ experiment.name }}</h3>
            <span 
              class="experiment-status" 
              [class]="experiment.status">
              {{ experiment.status }}
            </span>
          </div>
          
          <div class="experiment-variants">
            <div 
              *ngFor="let variant of experiment.variants"
              class="variant-item">
              <span class="variant-name">Variant {{ variant }}</span>
              <div class="variant-metrics">
                <span>50% traffic</span>
                <span>12.5% conversion</span>
              </div>
            </div>
          </div>
          
          <div class="experiment-actions">
            <button 
              class="btn-toggle"
              (click)="onExperimentToggle(experiment)">
              {{ experiment.status === 'running' ? 'Pause' : 'Resume' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Analytics Tools -->
    <div class="tools-section">
      <div class="section-header">
        <h2>🛠️ Advanced Tools</h2>
      </div>
      
      <div class="tools-grid">
        <!-- Heatmap Tool -->
        <div class="tool-card">
          <h3>🔥 Heatmap Analysis</h3>
          <p>Generate click heatmaps to understand user behavior</p>
          <button class="tool-btn" (click)="generateHeatmap()">
            Generate Heatmap
          </button>
          <canvas 
            #heatmapCanvas 
            class="heatmap-canvas"
            style="display: none; width: 100%; max-width: 400px; height: 300px; border: 1px solid #ddd; margin-top: 10px;">
          </canvas>
        </div>
        
        <!-- User Journey Tool -->
        <div class="tool-card">
          <h3>🗺️ User Journey</h3>
          <p>Analyze complete user journeys and paths</p>
          <button class="tool-btn" (click)="showUserJourney()">
            View User Journeys
          </button>
        </div>
        
        <!-- Custom Event Tracker -->
        <div class="tool-card">
          <h3>📝 Custom Events</h3>
          <p>Track custom events and interactions</p>
          <button class="tool-btn" (click)="trackCustomEvent()">
            Track Custom Event
          </button>
        </div>
        
        <!-- Configuration -->
        <div class="tool-card">
          <h3>⚙️ Configuration</h3>
          <p>Update analytics settings and preferences</p>
          <button class="tool-btn" (click)="updateAnalyticsConfig()">
            Update Config
          </button>
        </div>
      </div>
    </div>

    <!-- Recent Events Timeline -->
    <div class="timeline-section" *ngIf="recentEvents.length > 0">
      <div class="section-header">
        <h2>⏰ Recent Events Timeline</h2>
      </div>
      
      <div class="timeline-container">
        <div 
          *ngFor="let event of recentEvents.slice(0, 20)"
          class="timeline-event">
          <div class="event-time">
            {{ event.timestamp | date:'short' }}
          </div>
          <div class="event-content">
            <span class="event-type">{{ getEventTypeIcon(event.type) }}</span>
            <div class="event-details">
              <div class="event-action">{{ event.category }} / {{ event.action }}</div>
              <div class="event-meta" *ngIf="event.label || event.value">
                <span *ngIf="event.label">{{ event.label }}</span>
                <span *ngIf="event.value"> ({{ event.value }})</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="section-header">
        <h2>🔍 Data Filters</h2>
      </div>
      
      <div class="filters-grid">
        <div 
          *ngFor="let filter of availableFilters"
          class="filter-group">
          <h3>{{ filter.label }}</h3>
          <div class="filter-options">
            <button
              *ngFor="let option of filter.options"
              class="filter-option"
              [class.active]="isFilterActive(filter.key, option)"
              (click)="onFilterToggle(filter.key, option)">
              {{ option }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Privacy Controls -->
    <div class="privacy-section">
      <div class="section-header">
        <h2>🔒 Privacy & Data Controls</h2>
      </div>
      
      <div class="privacy-controls">
        <div class="privacy-option">
          <h3>Privacy Mode</h3>
          <p>Enable privacy mode to anonymize user data</p>
          <button class="privacy-btn" (click)="onPrivacyModeToggle()">
            Toggle Privacy Mode
          </button>
        </div>
        
        <div class="privacy-option">
          <h3>Tracking Consent</h3>
          <p>Allow users to opt out of analytics tracking</p>
          <button class="privacy-btn" (click)="onOptOutToggle()">
            Toggle Tracking
          </button>
        </div>
        
        <div class="privacy-option">
          <h3>Data Management</h3>
          <p>Clear all stored analytics data</p>
          <button class="privacy-btn danger" (click)="onClearData()">
            Clear All Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && !metrics">
    <div class="empty-icon">📊</div>
    <h2>No Analytics Data</h2>
    <p>Analytics data will appear here once user interactions are tracked.</p>
    <button class="empty-action" (click)="loadDashboardData()">
      Refresh Data
    </button>
  </div>
</div>
